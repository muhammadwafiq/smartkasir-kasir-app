<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - SmartKasir</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
        }
        .navbar {
            background: #1f2937;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar h1 { font-size: 24px; font-weight: 600; }
        .logout-btn {
            background: #ef4444;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 500;
        }
        .logout-btn:hover { background: #dc2626; }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        .period-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .period-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            color: #6b7280;
        }
        .period-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
        }
        .stat-card.success { border-left-color: #10b981; }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
        }
        .stat-subtitle {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 8px;
        }
        .section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        .section h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 24px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            font-size: 12px;
            text-transform: uppercase;
        }
        table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }
        table tr:hover { background: #f9fafb; }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge.danger { background: #fee2e2; color: #7f1d1d; }
        .badge.warning { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üìä Manager Dashboard</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    <div class="container">
        <div class="period-filter">
            <button class="period-btn active" onclick="changePeriod('today', this)">Today</button>
            <button class="period-btn" onclick="changePeriod('7days', this)">7 Days</button>
            <button class="period-btn" onclick="changePeriod('30days', this)">30 Days</button>
        </div>
        <div class="stats" id="statsContainer">
            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">Loading...</div>
        </div>
        <div class="section">
            <h2>üìà Revenue Trends</h2>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
        <div class="section">
            <h2>üèÜ Top Products</h2>
            <table id="productsTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Revenue</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody id="productsBody"></tbody>
            </table>
        </div>
        <div class="section">
            <h2>‚ö†Ô∏è Stock Alerts</h2>
            <table id="alertsTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Stock (Current/Min)</th>
                        <th>Days to Stockout</th>
                        <th>Recommended Reorder</th>
                        <th>Stock %</th>
                        <th>Urgency</th>
                    </tr>
                </thead>
                <tbody id="alertsBody"></tbody>
            </table>
        </div>
    </div>
    <script>
        let revenueChart = null;
        
        function changePeriod(period, btn) {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadAnalytics(period);
        }
        
        async function loadAnalytics(period = 'today') {
            try {
                const res = await fetch(`/api/manager/analytics?period=${period}`);
                const data = await res.json();
                
                if (!data.success) throw new Error('Failed to load');
                
                // Stats
                const total = data.topProducts.reduce((s, p) => s + p.revenue, 0);
                document.getElementById('statsContainer').innerHTML = `
                    <div class="stat-card success">
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-value">Rp ${data.totalRevenue.toLocaleString('id-ID')}</div>
                        <div class="stat-subtitle">${data.totalTransactions} transactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Transaction</div>
                        <div class="stat-value">Rp ${Math.round(data.avgTransaction).toLocaleString('id-ID')}</div>
                        <div class="stat-subtitle">Health: ${data.healthScore}%</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Profit (30%)</div>
                        <div class="stat-value">Rp ${data.totalProfit.toLocaleString('id-ID')}</div>
                        <div class="stat-subtitle">Margin: ${data.profitMargin}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Stock Alerts</div>
                        <div class="stat-value">${data.stockAlerts}</div>
                        <div class="stat-subtitle">Items need attention</div>
                    </div>
                `;
                
                // Chart
                const ctx = document.getElementById('revenueChart').getContext('2d');
                if (revenueChart) revenueChart.destroy();
                
                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.revenueTrend.map(i => i.label),
                        datasets: [{
                            label: 'Revenue',
                            data: data.revenueTrend.map(i => i.revenue),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointBackgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
                
                // Products
                document.getElementById('productsBody').innerHTML = data.topProducts.map(p => `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.qty}</td>
                        <td>Rp ${p.revenue.toLocaleString('id-ID')}</td>
                        <td>${((p.revenue/total)*100).toFixed(1)}%</td>
                    </tr>
                `).join('') || '<tr><td colspan="4">No data</td></tr>';
                
                // Alerts
                fetchAlerts();
            } catch (e) {
                console.error(e);
                alert('Error loading dashboard');
            }
        }
        
        async function fetchAlerts() {
            try {
                const res = await fetch('/api/manager/stock-alerts');
                const data = await res.json();
                
                if (!data.success || !data.alerts) {
                    document.getElementById('alertsBody').innerHTML = '<tr><td colspan="6">No alerts</td></tr>';
                    return;
                }
                
                // Color mapping by urgency
                const urgencyColors = {
                    critical: { bg: '#fee2e2', text: '#991b1b', label: 'üî¥ CRITICAL' },
                    high: { bg: '#fef3c7', text: '#92400e', label: 'üü† HIGH' },
                    normal: { bg: '#dbeafe', text: '#0c2340', label: 'üîµ NORMAL' },
                    low: { bg: '#dcfce7', text: '#166534', label: 'üü¢ LOW' }
                };
                
                document.getElementById('alertsBody').innerHTML = data.alerts.map(a => {
                    const urgency = urgencyColors[a.urgency] || urgencyColors.normal;
                    return `
                        <tr style="background: ${urgency.bg};">
                            <td><strong>${a.name}</strong></td>
                            <td>${a.currentStock}/${a.minimumStock}</td>
                            <td>${a.daysToStockout} days</td>
                            <td>${a.recommendedReorder} units</td>
                            <td>${a.stockPercent.toFixed(1)}%</td>
                            <td><span style="color: ${urgency.text}; font-weight: bold;">${urgency.label}</span></td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="6">No alerts</td></tr>';
            } catch (e) {
                console.error('Error fetching alerts:', e);
                document.getElementById('alertsBody').innerHTML = '<tr><td colspan="6">Error loading alerts</td></tr>';
            }
        }
        
        function logout() {
            window.location.href = '/logout';
        }
        
        loadAnalytics();
    </script>
</body>
</html>
